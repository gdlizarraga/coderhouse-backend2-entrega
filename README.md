# Sistema CRUD de Usuarios con Autenticaci√≥n y Autorizaci√≥n

## Descripci√≥n

Sistema completo de gesti√≥n de usuarios con autenticaci√≥n JWT y autorizaci√≥n basada en roles, desarrollado con Node.js, Express, MongoDB, Passport y bcrypt.

## Caracter√≠sticas Principales

### ‚úÖ Modelo de Usuario

- **Campos requeridos**: first_name, last_name, email, age, password
- **Campos adicionales**: cart (referencia a Carts), role (default: 'user')
- **Validaciones**: Email √∫nico, edad m√≠nima 18 a√±os, contrase√±as seguras
- **Encriptaci√≥n**: Contrase√±as encriptadas con bcrypt.hashSync

### ‚úÖ Sistema de Autenticaci√≥n

- **JWT (JSON Web Tokens)** para autenticaci√≥n stateless
- **Passport.js** con estrategias Local y JWT
- **Estrategia "current"** para validaci√≥n de usuario logueado
- **Middleware de autorizaci√≥n** por roles

### ‚úÖ API RESTful Completa

- **CRUD completo** de usuarios
- **Autenticaci√≥n y autorizaci√≥n** robusta
- **Validaci√≥n de entrada** con express-validator
- **Manejo de errores** centralizado

### üåê Interfaz Web Completa

- **P√°ginas web din√°micas** con Handlebars
- **Panel de administraci√≥n** para gesti√≥n de usuarios
- **Sistema de login/registro** con formularios responsivos
- **P√°ginas de perfil** y configuraci√≥n de usuario
- **Dise√±o Bootstrap 5.3.2** completamente responsivo
- **JavaScript modular** para funcionalidades din√°micas

## Instalaci√≥n y Configuraci√≥n

### Prerrequisitos

- Node.js (v16 o superior)
- MongoDB (local o Atlas)
- NPM o Yarn

### 1. Clonar e Instalar

```bash
cd c:\xampp_8.2.4\htdocs\coderhouse\backend2\entregas_web
npm install
```

### 2. Configurar Variables de Entorno

Editar el archivo `.env`:

```env
NODE_ENV=development
PORT=3000
MONGODB_URI=mongodb://localhost:27017/coderhouse_backend
JWT_SECRET=your_super_secret_jwt_key_here_change_in_production
JWT_EXPIRES_IN=24h
```

### 3. Iniciar MongoDB

Aseg√∫rate de que MongoDB est√© ejecut√°ndose:

```bash
# Windows (si tienes MongoDB instalado)
net start MongoDB

# O usar MongoDB Atlas (URI en .env)
```

### 4. Crear Usuarios de Prueba

```bash
node create-test-users.js
```

### 5. Ejecutar el Servidor

```bash
# Desarrollo
npm run dev

# Producci√≥n
npm start
```

El servidor estar√° disponible en: **http://localhost:3000**

## üåê P√°ginas Web Disponibles

### üè† P√°gina Principal

- **URL**: `http://localhost:3000/`
- **Descripci√≥n**: P√°gina de inicio con informaci√≥n del sistema
- **Acceso**: P√∫blico y usuarios autenticados

### üîê Autenticaci√≥n

#### Iniciar Sesi√≥n

- **URL**: `http://localhost:3000/login`
- **Descripci√≥n**: Formulario de inicio de sesi√≥n
- **Caracter√≠sticas**:
  - Validaci√≥n en tiempo real
  - Mostrar/ocultar contrase√±a
  - Recordar sesi√≥n
  - Redirecci√≥n autom√°tica seg√∫n rol

#### Registrarse

- **URL**: `http://localhost:3000/register`
- **Descripci√≥n**: Formulario de registro de nuevos usuarios
- **Caracter√≠sticas**:
  - Validaci√≥n completa de campos
  - Confirmaci√≥n de contrase√±a
  - T√©rminos y condiciones
  - Validaci√≥n de edad (18+)

### üë• Gesti√≥n de Usuarios (Solo Admin)

- **URL**: `http://localhost:3000/users`
- **Descripci√≥n**: Panel de administraci√≥n de usuarios
- **Acceso**: Solo usuarios con rol `admin`
- **Caracter√≠sticas**:
  - Tabla completa de usuarios con paginaci√≥n
  - B√∫squeda en tiempo real
  - Filtros por rol
  - CRUD completo (Crear, Leer, Actualizar, Eliminar)
  - Modales para operaciones
  - Confirmaci√≥n de eliminaci√≥n
  - Dise√±o responsivo

### üé® Dise√±o y UX

- **Framework CSS**: Bootstrap 5.3.2
- **Iconos**: Bootstrap Icons
- **Motor de Plantillas**: Handlebars
- **Responsive**: Completamente adaptable a m√≥viles
- **Tema**: Dise√±o moderno con colores profesionales

## üîë Usuarios de Prueba

Para probar la aplicaci√≥n web, puedes usar estas credenciales:

| Rol         | Email              | Contrase√±a   | Descripci√≥n                |
| ----------- | ------------------ | ------------ | -------------------------- |
| **Admin**   | `admin@test.com`   | `admin123`   | Acceso completo al sistema |
| **Premium** | `premium@test.com` | `premium123` | Usuario premium            |
| **Usuario** | `user@test.com`    | `user123`    | Usuario est√°ndar           |

### Acceso R√°pido:

1. Ve a `http://localhost:3000/login`
2. Usa las credenciales de admin para acceder al panel de usuarios
3. Usa las credenciales de usuario regular para ver la experiencia normal

## üì° Endpoints de la API

### üåê Rutas Web (Interfaz Visual)

#### P√°ginas P√∫blicas

- **GET `/`** - P√°gina principal con navegaci√≥n
- **GET `/login`** - Formulario de inicio de sesi√≥n
- **GET `/register`** - Formulario de registro p√∫blico

#### P√°ginas Protegidas (requieren autenticaci√≥n)

- **GET `/profile`** - P√°gina de perfil del usuario
- **GET `/settings`** - Configuraci√≥n de cuenta

#### P√°ginas de Administraci√≥n (solo admin)

- **GET `/users`** - Panel de administraci√≥n con CRUD de usuarios

---

### üîì Endpoints P√∫blicos de la API

#### Registro P√∫blico de Usuario

```http
POST /api/users/signup
Content-Type: application/json

{
  "first_name": "Juan",
  "last_name": "P√©rez",
  "email": "juan@email.com",
  "age": 25,
  "password": "MiPassword123"
}
```

> ‚ö†Ô∏è **Seguridad**: Esta ruta solo permite registrar usuarios con rol 'user'. El campo 'role' es rechazado autom√°ticamente.

#### Registro de Administrador para Pruebas

```http
POST /api/users/signup_test
Content-Type: application/json

{
  "first_name": "Admin",
  "last_name": "Test",
  "email": "admin@test.com",
  "age": 30,
  "password": "admin123"
}
```

> üß™ **Solo para Testing**: Esta ruta crea autom√°ticamente usuarios con rol 'admin'. **NO debe existir en producci√≥n**.

#### Registro de Usuario (Solo Admin)

```http
POST /api/users/register
Content-Type: application/json

{
  "first_name": "Juan",
  "last_name": "P√©rez",
  "email": "juan@email.com",
  "age": 25,
  "password": "MiPassword123",
  "role": "premium"
}
```

> üîí **Autorizaci√≥n**: Esta ruta requiere autenticaci√≥n de administrador y permite especificar cualquier rol.

#### Iniciar Sesi√≥n

```http
POST /api/sessions/login
Content-Type: application/json

{
  "email": "juan@email.com",
  "password": "MiPassword123"
}
```

### üîí Endpoints Privados

**Nota**: Incluir el token JWT en el header:

```http
Authorization: Bearer <tu_token_jwt>
```

#### Validar Usuario Actual (Endpoint Principal)

```http
GET /api/sessions/current
Authorization: Bearer <token>
```

**Respuesta exitosa**:

```json
{
  "success": true,
  "message": "Usuario autenticado correctamente",
  "data": {
    "user": {
      "id": "...",
      "first_name": "Juan",
      "last_name": "P√©rez",
      "email": "juan@email.com",
      "age": 25,
      "role": "user",
      "cart": {...},
      "fullName": "Juan P√©rez"
    },
    "token": "nuevo_token_renovado",
    "expiresIn": "24h"
  }
}
```

#### Obtener Perfil del Usuario

```http
GET /api/users/profile/me
Authorization: Bearer <token>
```

#### Actualizar Perfil

```http
PUT /api/users/profile/me
Authorization: Bearer <token>
Content-Type: application/json

{
  "first_name": "Juan Carlos",
  "age": 26
}
```

#### Listar Usuarios (Solo Admin)

```http
GET /api/users?page=1&limit=10&role=user
Authorization: Bearer <admin_token>
```

#### Cambiar Contrase√±a

```http
POST /api/sessions/change-password
Authorization: Bearer <token>
Content-Type: application/json

{
  "currentPassword": "MiPassword123",
  "newPassword": "NuevaPassword456"
}
```

### üõ†Ô∏è Endpoints de Utilidad

#### Verificar Estado del Servidor

```http
GET /api/health
```

#### Validar Token

```http
GET /api/sessions/validate
Authorization: Bearer <token>
```

#### Renovar Token

```http
POST /api/sessions/refresh
Authorization: Bearer <token>
```

## üîí Seguridad Mejorada

### Separaci√≥n de Endpoints de Registro

Por razones de seguridad, el sistema ahora cuenta con **tres endpoints separados** para el registro de usuarios:

#### üåç Registro P√∫blico (`/api/users/signup`)

- **Prop√≥sito**: Registro de usuarios desde la interfaz web p√∫blica
- **Restricciones de Seguridad**:
  - Solo permite rol `'user'` (autom√°tico)
  - El campo `role` es **rechazado** si se env√≠a
  - Validaci√≥n especial con `validatePublicUserRegistration`
- **Uso**: Formulario de registro p√∫blico en `/register`

#### üß™ Registro de Testing (`/api/users/signup_test`)

- **Prop√≥sito**: Crear usuarios administradores para pruebas y desarrollo
- **Caracter√≠sticas**:
  - Crea autom√°ticamente usuarios con rol `'admin'`
  - **SOLO PARA DESARROLLO** - debe removerse en producci√≥n
  - Permite crear administradores sin autenticaci√≥n previa
- **Uso**: Testing y setup inicial del sistema

#### üîê Registro Administrativo (`/api/users/register`)

- **Prop√≥sito**: Creaci√≥n de usuarios por administradores
- **Caracter√≠sticas**:
  - Requiere **autenticaci√≥n de administrador**
  - Permite especificar **cualquier rol** (`user`, `premium`, `admin`)
  - Validaci√≥n completa con `validateUserRegistration`
- **Uso**: Panel de administraci√≥n en `/users`

### Validaciones de Seguridad

- **Middleware especializado** para cada tipo de registro
- **Sanitizaci√≥n** autom√°tica de campos sensibles
- **Verificaci√≥n de roles** en tiempo real
- **Tokens JWT** con expiraci√≥n autom√°tica
- **Encriptaci√≥n** de contrase√±as con bcrypt

### ‚ö†Ô∏è Advertencias de Seguridad

> **üö® IMPORTANTE**: La ruta `/api/users/signup_test` es **SOLO PARA DESARROLLO**.
>
> **Debe eliminarse antes del despliegue en producci√≥n** ya que permite crear administradores sin autenticaci√≥n, lo cual representa un **riesgo de seguridad cr√≠tico**.
>
> Para producci√≥n, usar √∫nicamente:
>
> - `/api/users/signup` (registro p√∫blico de usuarios)
> - `/api/users/register` (registro administrativo autenticado)

## Roles y Permisos

### Roles Disponibles

- **user**: Usuario est√°ndar (default)
- **premium**: Usuario premium
- **admin**: Administrador

### Permisos por Rol

| Funcionalidad                  | user | premium | admin |
| ------------------------------ | ---- | ------- | ----- |
| **API Endpoints**              |      |         |       |
| Registrarse (signup)           | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Registrarse test (signup_test) | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Login                          | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Ver su perfil                  | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Editar su perfil               | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Ver todos los usuarios         | ‚ùå   | ‚ùå      | ‚úÖ    |
| Crear usuarios (register)      | ‚ùå   | ‚ùå      | ‚úÖ    |
| Editar cualquier usuario       | ‚ùå   | ‚ùå      | ‚úÖ    |
| Eliminar usuarios              | ‚ùå   | ‚ùå      | ‚úÖ    |
| **Interfaz Web**               |      |         |       |
| P√°gina de login                | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| P√°gina de registro             | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| P√°gina de perfil               | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| P√°gina de configuraci√≥n        | ‚úÖ   | ‚úÖ      | ‚úÖ    |
| Panel de administraci√≥n        | ‚ùå   | ‚ùå      | ‚úÖ    |
| CRUD de usuarios (web)         | ‚ùå   | ‚ùå      | ‚úÖ    |

## Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ app.js                 # Servidor principal con Handlebars
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database.js        # Configuraci√≥n MongoDB
‚îÇ   ‚îî‚îÄ‚îÄ passport.js        # Estrategias Passport
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js           # Middleware autenticaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ validation.js     # Validaciones
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ User.js          # Modelo Usuario
‚îÇ   ‚îî‚îÄ‚îÄ Cart.js          # Modelo Carrito
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ users.js         # CRUD usuarios (API)
‚îÇ   ‚îú‚îÄ‚îÄ sessions.js      # Autenticaci√≥n (API)
‚îÇ   ‚îî‚îÄ‚îÄ views.js         # Rutas para vistas web
‚îú‚îÄ‚îÄ views/               # Plantillas Handlebars
‚îÇ   ‚îú‚îÄ‚îÄ layouts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.handlebars    # Layout principal
‚îÇ   ‚îú‚îÄ‚îÄ home.handlebars        # P√°gina de inicio
‚îÇ   ‚îú‚îÄ‚îÄ login.handlebars       # P√°gina de login
‚îÇ   ‚îú‚îÄ‚îÄ register.handlebars    # P√°gina de registro
‚îÇ   ‚îú‚îÄ‚îÄ users.handlebars       # Panel admin usuarios
‚îÇ   ‚îî‚îÄ‚îÄ error.handlebars       # P√°gina de error
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ auth.js          # Utilidades JWT y bcrypt

public/                  # Archivos est√°ticos
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ custom.css      # Estilos personalizados
‚îî‚îÄ‚îÄ js/
    ‚îú‚îÄ‚îÄ main.js         # JavaScript principal
    ‚îî‚îÄ‚îÄ users-admin.js  # JavaScript para gesti√≥n usuarios
```

## Seguridad Implementada

### üîê Encriptaci√≥n de Contrase√±as

- **bcrypt.hashSync** con 12 salt rounds
- Contrase√±as nunca almacenadas en texto plano
- Comparaci√≥n segura con bcrypt.compareSync

### üé´ JSON Web Tokens (JWT)

- Tokens con expiraci√≥n configurable (24h default)
- Payload m√≠nimo con datos esenciales
- Renovaci√≥n autom√°tica de tokens

### üõ°Ô∏è Validaciones y Sanitizaci√≥n

- Validaci√≥n de entrada con express-validator
- Sanitizaci√≥n de email (lowercase, trim)
- Validaciones de tipo y rango

### üö´ Protecci√≥n contra Vulnerabilidades

- CORS configurado
- Headers de seguridad
- Manejo seguro de errores
- Validaci√≥n de ownership

## Testing de la API

### Usando curl

```bash
# 1. Registrar usuario
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "Juan",
    "last_name": "P√©rez",
    "email": "juan@test.com",
    "age": 25,
    "password": "Test123"
  }'

# 2. Login
curl -X POST http://localhost:8080/api/sessions/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "juan@test.com",
    "password": "Test123"
  }'

# 3. Validar usuario (usar token del login)
curl -X GET http://localhost:8080/api/sessions/current \
  -H "Authorization: Bearer <TOKEN_AQUI>"
```

### Usando Postman/Insomnia

1. **Importar Collection**: Crear requests con los endpoints anteriores
2. **Configurar Environment**: `BASE_URL=http://localhost:8080`
3. **Automatizar Token**: Guardar token del login autom√°ticamente

## Criterios Cumplidos ‚úÖ

### ‚úÖ Modelo de Usuario y Encriptaci√≥n

- ‚úÖ Modelo User con todos los campos especificados
- ‚úÖ Contrase√±a encriptada con bcrypt.hashSync
- ‚úÖ Almacenamiento seguro en base de datos
- ‚úÖ Campo email √∫nico con validaci√≥n

### ‚úÖ Estrategias de Passport

- ‚úÖ Estrategia Local para login
- ‚úÖ Estrategia JWT para autenticaci√≥n
- ‚úÖ Estrategia "current" para validaci√≥n de usuario logueado
- ‚úÖ Configuraci√≥n correcta para el modelo de usuarios

### ‚úÖ Sistema de Login y JWT

- ‚úÖ Login funcional con generaci√≥n de JWT
- ‚úÖ Token JWT v√°lido con datos del usuario
- ‚úÖ Expiraci√≥n configurable (24h)
- ‚úÖ Payload seguro con informaci√≥n m√≠nima

### ‚úÖ Endpoint /api/sessions/current

- ‚úÖ Ruta /current implementada en /api/sessions/
- ‚úÖ Validaci√≥n de usuario logueado con estrategia "current"
- ‚úÖ Retorno de datos asociados al JWT
- ‚úÖ Manejo de errores con tokens inv√°lidos/inexistentes
- ‚úÖ Respuestas apropiadas de Passport

### ‚úÖ Vistas Web con Handlebars

- ‚úÖ **P√°gina de Login** con formulario Bootstrap y validaciones
- ‚úÖ **P√°gina de Registro** con validaciones completas
- ‚úÖ **Panel de Usuarios para Admin** con CRUD completo
- ‚úÖ **Men√∫ de navegaci√≥n** din√°mico seg√∫n rol
- ‚úÖ **Dise√±o responsivo** con Bootstrap 5
- ‚úÖ **Autenticaci√≥n en vistas** con middleware personalizado
- ‚úÖ **JavaScript del cliente** para interactividad
- ‚úÖ **Gesti√≥n de tokens** en localStorage/sessionStorage

## üöÄ C√≥mo Probar la Aplicaci√≥n

### 1. Iniciar el Servidor

```bash
npm run dev
```

### 2. Crear Usuarios de Prueba (si no existen)

```bash
npm run seed
```

### 3. Probar las Vistas Web

#### Como Usuario Administrador:

1. Ve a `http://localhost:3000/login`
2. Inicia sesi√≥n con: `admin@test.com` / `admin123`
3. Accede al panel de usuarios en `http://localhost:3000/users`
4. Prueba las funcionalidades CRUD:
   - ‚úÖ Crear nuevo usuario
   - ‚úÖ Editar usuarios existentes
   - ‚úÖ Eliminar usuarios
   - ‚úÖ Buscar y filtrar usuarios
   - ‚úÖ Paginaci√≥n

#### Como Usuario Regular:

1. Ve a `http://localhost:3000/login`
2. Inicia sesi√≥n con: `user@test.com` / `user123`
3. Explora la p√°gina de inicio
4. Nota que no puedes acceder al panel de usuarios

#### Registro de Nuevos Usuarios:

1. Ve a `http://localhost:3000/register`
2. Completa el formulario de registro
3. Prueba las validaciones en tiempo real

#### üß™ Crear Administrador para Testing:

Si necesitas crear un usuario administrador r√°pidamente para pruebas, puedes usar el endpoint especial de testing:

```bash
# Usando curl (PowerShell/Cmd)
curl -X POST http://localhost:3000/api/users/signup_test ^
  -H "Content-Type: application/json" ^
  -d "{\"first_name\":\"Admin\",\"last_name\":\"Test\",\"email\":\"admin.test@example.com\",\"age\":30,\"password\":\"admin123\"}"

# O usando el archivo api-tests.http
# Buscar la secci√≥n "Registro de Admin para Testing"
```

> ‚ö†Ô∏è **Recordatorio**: Esta ruta debe eliminarse antes del despliegue en producci√≥n. 3. Prueba las validaciones en tiempo real

### 4. Probar la API (Opcional)

Todos los endpoints de la API siguen funcionando igual:

- `GET http://localhost:3000/api/health`
- `POST http://localhost:3000/api/sessions/login`
- `GET http://localhost:3000/api/sessions/current`
- etc.

````

## üöÄ Nuevas Funcionalidades Implementadas

### üåê Interfaz Web Completa

- **P√°ginas din√°micas** con Handlebars y Bootstrap 5.3.2
- **Sistema de autenticaci√≥n web** con formularios responsivos
- **Panel de administraci√≥n** con CRUD completo de usuarios
- **P√°ginas de perfil** y configuraci√≥n personalizadas
- **Navegaci√≥n intuitiva** con men√∫s contextuales por rol

### üîí Seguridad Mejorada

- **Endpoints separados** para registro p√∫blico vs administrativo
- **Ruta de testing** para crear administradores en desarrollo
- **Validaci√≥n diferenciada** seg√∫n el tipo de usuario
- **Restricci√≥n autom√°tica** de roles en registro p√∫blico
- **Middleware especializado** para cada nivel de acceso
- **Advertencias de seguridad** para rutas de desarrollo

### üé® Experiencia de Usuario

- **Dise√±o moderno** y completamente responsivo
- **Validaciones en tiempo real** en formularios
- **Modales interactivos** para operaciones cr√≠ticas
- **B√∫squeda y filtrado** din√°mico en tablas
- **Feedback visual** inmediato para todas las acciones

### üõ†Ô∏è Arquitectura T√©cnica

- **Helpers personalizados** de Handlebars (`contentFor`, `section`, `eq`, `formatDate`)
- **JavaScript modular** organizado por funcionalidad
- **Sistema de layouts** flexible y reutilizable
- **Manejo de errores** unificado entre API y web
- **Autenticaci√≥n h√≠brida** (JWT + cookies) para mejor UX

---

## Troubleshooting

### Error de Conexi√≥n MongoDB

```bash
# Verificar que MongoDB est√© ejecut√°ndose
mongosh --eval "db.runCommand('ping')"

# O verificar la URI en .env
````

### Error JWT_SECRET

```bash
# Asegurar que JWT_SECRET est√© configurado en .env
echo $JWT_SECRET  # Linux/Mac
echo %JWT_SECRET% # Windows
```

### Error de Puerto

```bash
# Cambiar puerto en .env si 8080 est√° ocupado
PORT=3000
```

## Autor

Sistema desarrollado para Coderhouse - Backend Programming Course

- **Curso**: Backend 2
- **Entrega**: Sistema CRUD con Autenticaci√≥n JWT + Interfaz Web Completa
- **Tecnolog√≠as**: Node.js, Express, MongoDB, Passport, bcrypt, Handlebars, Bootstrap
- **Caracter√≠sticas**: API REST + Interfaz Web + Seguridad Avanzada + UX Moderna

**¬°Aplicaci√≥n lista para producci√≥n!** üéâ
